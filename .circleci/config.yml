aliases:
  # Common caches
  - &restore-yarn-cache
    keys:
      - package-cache-v1-{{ arch }}-{{ .Branch }}-{{ checksum "CICD/package.json" }}
      - package-cache-v1-{{ arch }}-{{ .Branch }}-
      - package-cache-v1-{{ arch }}-master-

  - &save-yarn-cache
    paths:
      - CICD/node_modules
      - ~/CICD/.cache/yarn
    key: package-cache-v1-{{ arch }}-{{ .Branch }}-{{ checksum "CICD/package.json" }}

  - &restore-react-native-cli
    keys:
      - react-native-cli-cache-v1-{{ arch }}

  - &save-react-native-cli
    paths:
      - CICD/node_modules
    key: react-native-cache-v1-{{ arch }}

  # Android cache
  - &restore-gem-android
    keys:
      - gem-android-cache-v1-{{ arch }}-{{ .Branch }}-{{ checksum "CICD/android/Gemfile.lock" }}
      # Fallback in case checksum fails
      - gem-android-cache-v1-{{ arch }}-{{ .Branch }}-
      # Fallback in case this is a first-time run on a fork
      - gem-android-cache-v1-{{ arch }}-master-

  - &save-gem-android
    paths:
      - CICD/android/vendor/bundle
    key: gem-android-cache-v1-{{ arch }}-{{ .Branch }}-{{ checksum "CICD/android/Gemfile.lock" }}

  # Select branch to build
  - &branches
    only:
      - beta
      - master
    
  - &install-node-version
    name: Install Nodejs version 14.2.0
    command: |
      curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.0/install.sh | bash
      echo 'export NVM_DIR="/Users/distiller/.nvm"' >> $BASH_ENV
      echo ' [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> $BASH_ENV # This loads nvm
      source /Users/distiller/.bashrc
      nvm install v14.2.0
      nvm use v14.2.0

  - &install-react-native-cli
    name: Install react-native-cli
    command: |
      cd CICD && yarn add react-native-cli

  - &install-fastlane-android
    name: Install fastlane
    command: |
      cd CICD/android
      bundle update
      gem install json
      bundle install --path vendor/bundle

  - &yarn
    name: Install Node Dependencies
    command: |
      rm -rf node_modules
      rm -rf ~/.rncache
      cd CICD && yarn cache clean && yarn install

  - &test
    name: Run unit test
    command: |
      cd CICD && yarn test --coverage

    # Jest CLI Options: https://jestjs.io/docs/en/cli.html
  - &version-patch
    name: version patch
    command: |
      cd CICD
      npm version patch

  - &install-awscli
    name: Install awscli
    command: sudo pip install awscli

  - &build-apk-upload-upload_store
    name: Build apk & upload
    command: |
      cd CICD/android
      export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
      export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY

      if [[ $CIRCLE_BRANCH == "beta" ]]; then
        bundle exec fastlane beta upload_store:false
        aws s3 cp ~/CICD/CICD/android/app/build/outputs/apk/beta/app-beta.apk "s3://${AWS_S3_BUCKET_NAME}/beta/$(date +'%y')-$(date +'%m')-$(date +'%d')/cicd-beta.apk"
      elif [[ $CIRCLE_BRANCH == "master" ]]; then
        bundle exec fastlane prod upload_store:false
        aws s3 cp ~/CICD/CICD/android/app/build/outputs/apk/prod/app-prod.apk "s3://${AWS_S3_BUCKET_NAME}/prod/$(date +'%y')-$(date +'%m')-$(date +'%d')/cicd-prod.apk"
      fi
  - &decode-keys-android
    name: Decode the keystore files
    command: |
      if [[ $CIRCLE_BRANCH == "beta" ]]; then
        cd CICD/android/app && echo $ENCODED_KEYSTORE_BETA | sed 's/ /\n/g' | base64 --decode >> beta.keystore
      fi
      if [[ $CIRCLE_BRANCH == "master" ]]; then
        cd CICD/android/app && echo $ENCODED_PRODUCT_KEYSTORE | sed 's/ /\n/g' | base64 --decode >> release-product.keystore
      fi

version: 2

jobs:
  build:
    working_directory: ~/CICD
    docker:
      - image: circleci/node:14.2.0

    steps:
      - checkout

      - restore-cache: *restore-yarn-cache
      - run: *yarn
      - save-cache: *save-yarn-cache

      - persist_to_workspace:
          root: ~/CICD
          paths:
            - .

  test:
    working_directory: ~/CICD/
    docker:
      - image: circleci/node:14.2.0
    steps:
      - checkout

      - restore-cache: *restore-yarn-cache
      - run: *yarn
      - save-cache: *save-yarn-cache

      - run: *test

  android:
    working_directory: ~/CICD/
    docker:
      - image: circleci/android:api-29-node

    steps:
      - checkout
      - restore-cache: *restore-yarn-cache
      - run: *yarn
      - save-cache: *save-yarn-cache
      - restore-cache: *restore-gem-android
      - save-cache: *save-gem-android
      - run: *install-fastlane-android
      - run: *version-patch
      - run: *test
      - run:
          name: Approve license for build tools
          command: (echo y; echo y; echo y; echo y; echo y; echo y) | $ANDROID_HOME/tools/bin/sdkmanager --licenses

      - run: *decode-keys-android
      - run: *install-awscli
      - run: *build-apk-upload-upload_store

workflows:
  version: 2
  deploy:
    jobs:
      - build:
          filters:
            branches: *branches
      - android:
          requires:
            - build
          filters:
            branches: *branches
